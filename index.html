<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata Assistant for Stock</title>
    <link rel="icon" type="image/jpeg" href="https://i.ibb.co/qMj3MVMK/Md-Maruf-Hasan-Fiverr-Profile-Picture.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        /* Custom class for disabled button state */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Custom transition for smoother UI updates */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-white">AI Metadata Assistant</h1>
            </div>
            <button id="settings-btn" class="p-2 rounded-md hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-white">How it Works</h2>
                <div class="space-y-4 text-gray-400">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">1</div>
                        <p>Click the <strong class="text-gray-300">Settings</strong> icon (top right) to add your Google AI API key.</p>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">2</div>
                        <p>Click <strong class="text-gray-300">Select Files</strong> or <strong class="text-gray-300">Select Folder</strong> to choose your images.</p>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">3</div>
                        <p>Click <strong class="text-gray-300">Start Generation</strong> to have the AI write titles and keywords.</p>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">4</div>
                        <p>Review and edit the results, then click <strong class="text-gray-300">Download CSV</strong> for Adobe Stock.</p>
                    </div>
                </div>

                <div class="mt-8 space-y-4">
                    <input type="file" id="file-input" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                    <input type="file" id="folder-input" class="hidden" webkitdirectory directory multiple>

                    <div class="grid grid-cols-2 gap-4">
                        <button id="select-files-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                            Select Files
                        </button>
                        <button id="select-folder-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                            Select Folder
                        </button>
                    </div>
                    <button id="start-generation-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>
                        Start Generation
                    </button>
                    <button id="download-csv-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
                        Download CSV
                    </button>
                    
                    <div id="progress-container" class="hidden w-full space-y-2 pt-2">
                        <div class="flex justify-between text-sm font-medium text-gray-400">
                            <span id="progress-text">Processing...</span>
                            <span id="progress-time">ETA: --:--</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                 <p class="text-xs text-center text-gray-500 mt-6">This tool is designed for the <a href="https://contributor.stock.adobe.com/en/uploads" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-400">Adobe Stock Contributor Portal</a> CSV upload.</p>
            </aside>

            <section id="results-panel" class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg min-h-[60vh]">
                <div id="results-container" class="space-y-6">
                    <div id="placeholder" class="text-center text-gray-500 py-20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        <h3 class="text-lg font-medium text-gray-400">Your images will appear here</h3>
                        <p class="text-sm">Select some images to get started.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden transition-all">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="settings-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Settings</h2>
                <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Google AI API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-gray-900 border border-gray-700 text-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Enter your API key">
                    <p class="text-xs text-gray-500 mt-2">Your key is stored only in your browser's local storage and is never shared.</p>
                </div>
                <button id="save-api-key-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all">Save Key</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl translate-x-[120%] transition-transform duration-500">
        <p id="toast-message"></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Element Selectors ---
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsModalContent = document.getElementById('settings-modal-content');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const selectFilesBtn = document.getElementById('select-files-btn');
    const selectFolderBtn = document.getElementById('select-folder-btn');
    const fileInput = document.getElementById('file-input');
    const folderInput = document.getElementById('folder-input');
    const startGenerationBtn = document.getElementById('start-generation-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const resultsContainer = document.getElementById('results-container');
    const placeholder = document.getElementById('placeholder');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressTime = document.getElementById('progress-time');

    // --- Application State ---
    let apiKey = '';
    let imageFiles = []; // Will store { file, id, dataUrl } objects
    let results = {}; // Will store { id: { title, keywords, status } }

    // --- Initialization ---
    const init = () => {
        const savedKey = localStorage.getItem('googleAiApiKey');
        if (savedKey) {
            apiKey = savedKey;
            apiKeyInput.value = savedKey;
            showToast('API Key loaded from memory.', 'info');
        }
        updateButtonStates();
        attachEventListeners();
    };

    // --- Event Listeners ---
    const attachEventListeners = () => {
        settingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeSettingsModal();
        });
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        selectFolderBtn.addEventListener('click', () => folderInput.click());

        fileInput.addEventListener('change', (e) => processFileObjects(e.target.files));
        folderInput.addEventListener('change', (e) => processFileObjects(e.target.files));

        startGenerationBtn.addEventListener('click', handleGeneration);
        downloadCsvBtn.addEventListener('click', handleCsvDownload);
    };

    // --- UI Update Functions ---
    const updateButtonStates = () => {
        const hasApiKey = !!apiKey;
        const hasFiles = imageFiles.length > 0;
        const isGenerated = Object.values(results).length > 0 && Object.values(results).every(r => r.status === 'Complete' || r.status === 'Error');

        if (hasApiKey && hasFiles) {
            startGenerationBtn.classList.remove('btn-disabled');
        } else {
            startGenerationBtn.classList.add('btn-disabled');
        }

        if (hasFiles && isGenerated) {
            downloadCsvBtn.classList.remove('btn-disabled');
        } else {
            downloadCsvBtn.classList.add('btn-disabled');
        }
    };

    const renderResults = () => {
        if (imageFiles.length === 0) {
            placeholder.classList.remove('hidden');
            placeholder.querySelector('h3').textContent = 'Your images will appear here';
            placeholder.querySelector('p').textContent = 'Select some images to get started.';
            return;
        }
        placeholder.classList.add('hidden');
        resultsContainer.innerHTML = '';

        imageFiles.forEach(img => {
            const resultData = results[img.id] || { title: '', keywords: '', status: 'Pending' };
            const card = document.createElement('div');
            card.id = `card-${img.id}`;
            card.className = 'bg-gray-900 p-4 rounded-lg shadow-md flex flex-col md:flex-row gap-4 transition-all';
            
            let statusColor = 'text-yellow-400';
            if (resultData.status === 'Complete') statusColor = 'text-green-400';
            if (resultData.status === 'Error') statusColor = 'text-red-400';
            if (resultData.status === 'Generating...') statusColor = 'text-blue-400 animate-pulse';

            card.innerHTML = `
                <div class="flex-shrink-0 w-full md:w-48 h-32">
                    <img src="${img.dataUrl}" alt="${img.file.name}" class="w-full h-full object-cover rounded-md">
                </div>
                <div class="flex-grow space-y-2">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-gray-300 break-all">${img.file.name}</p>
                        <span id="status-${img.id}" class="text-sm font-medium ${statusColor}">${resultData.status}</span>
                    </div>
                    <div>
                        <label for="title-${img.id}" class="text-xs font-medium text-gray-400">Title</label>
                        <textarea id="title-${img.id}" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="updateResult('${img.id}', 'title', this.value)">${resultData.title}</textarea>
                    </div>
                    <div>
                        <label for="keywords-${img.id}" class="text-xs font-medium text-gray-400">Keywords</label>
                        <textarea id="keywords-${img.id}" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="updateResult('${img.id}', 'keywords', this.value)">${resultData.keywords}</textarea>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    };
    
    window.updateResult = (id, field, value) => {
        if (results[id]) {
            results[id][field] = value;
        }
    };

    const showToast = (message, type = 'success') => {
        toastMessage.textContent = message;
        toast.className = 'fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl transition-transform duration-500';
        if (type === 'success') toast.classList.add('bg-green-600');
        else if (type === 'error') toast.classList.add('bg-red-600');
        else toast.classList.add('bg-blue-600');
        
        toast.classList.remove('translate-x-[120%]');
        setTimeout(() => {
            toast.classList.add('translate-x-[120%]');
        }, 3000);
    };

    // --- Settings Modal Logic ---
    const openSettingsModal = () => {
        settingsModal.classList.remove('hidden');
        setTimeout(() => settingsModalContent.classList.remove('scale-95', 'opacity-0'), 10);
    };

    const closeSettingsModal = () => {
        settingsModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => settingsModal.classList.add('hidden'), 300);
    };

    const saveApiKey = () => {
        const key = apiKeyInput.value.trim();
        if (key) {
            apiKey = key;
            localStorage.setItem('googleAiApiKey', key);
            showToast('API Key saved successfully!');
            closeSettingsModal();
            updateButtonStates();
        } else {
            showToast('Please enter a valid API key.', 'error');
        }
    };

    // --- Core Functionality ---
    const processFileObjects = async (fileList) => {
        const files = Array.from(fileList);
        const imageExtensions = ['.png', '.jpg', '.jpeg', '.webp'];
        const imageFileObjects = files.filter(file => 
            imageExtensions.some(ext => file.name.toLowerCase().endsWith(ext))
        );

        if (imageFileObjects.length === 0) {
            showToast('No compatible image files found.', 'info');
            return;
        }
        
        imageFiles = [];
        results = {};
        
        placeholder.classList.remove('hidden');
        placeholder.querySelector('h3').textContent = 'Loading image previews...';
        placeholder.querySelector('p').textContent = `Found ${imageFileObjects.length} images.`;

        const filePromises = imageFileObjects.map(async (file) => {
            const id = `${file.name}-${file.lastModified}`;
            const dataUrl = await readFileAsDataURL(file);
            return { file, id, dataUrl };
        });

        imageFiles = await Promise.all(filePromises);

        renderResults();
        updateButtonStates();
        showToast(`${imageFiles.length} image(s) ready.`);
        
        fileInput.value = '';
        folderInput.value = '';
    };
    
    const readFileAsDataURL = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    const handleGeneration = async () => {
        if (startGenerationBtn.classList.contains('btn-disabled')) return;

        startGenerationBtn.classList.add('btn-disabled');
        downloadCsvBtn.classList.add('btn-disabled');

        const totalCount = imageFiles.length;
        let completedCount = 0;
        const startTime = Date.now();
        
        progressContainer.classList.remove('hidden');
        updateProgress(completedCount, totalCount, startTime);

        const generationPromises = imageFiles.map(img =>
            generateMetadataForImage(img)
                .finally(() => {
                    completedCount++;
                    updateProgress(completedCount, totalCount, startTime);
                })
        );
        
        await Promise.all(generationPromises);

        showToast('All images processed!', 'success');
        updateButtonStates();

        setTimeout(() => {
            progressContainer.classList.add('hidden');
        }, 2000);
    };
    
    const updateProgress = (completed, total, startTime) => {
        if (total === 0) return;

        const percentage = Math.round((completed / total) * 100);
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `Processing: ${completed} / ${total}`;
        
        if (completed > 0) {
            const elapsedTime = (Date.now() - startTime) / 1000; // in seconds
            const timePerImage = elapsedTime / completed;
            const remainingImages = total - completed;
            const etaSeconds = Math.round(remainingImages * timePerImage);
            
            if (remainingImages > 0) {
                const minutes = Math.floor(etaSeconds / 60);
                const seconds = etaSeconds % 60;
                progressTime.textContent = `ETA: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                progressTime.textContent = `Done!`;
                progressText.textContent = `Complete: ${total} / ${total}`
            }
        } else {
            progressTime.textContent = 'ETA: --:--';
        }
    };

    const generateMetadataForImage = async (img) => {
        const titleEl = document.getElementById(`title-${img.id}`);
        const keywordsEl = document.getElementById(`keywords-${img.id}`);

        try {
            updateStatus(img.id, 'Generating...');
            const base64Data = img.dataUrl.split(',')[1];
            const prompt = `You are an expert stock photo metadata creator for Adobe Stock. Analyze this image. Provide a descriptive, commercially viable title and a list of relevant keywords.
**Instructions:**
1. **Title:** A single, concise sentence. Maximum 200 characters. The title should be descriptive and appealing to buyers.
2. **Keywords:** A comma-separated list of up to 49 keywords. Order them from most to least important. Include concepts, objects, colors, mood, and potential uses. Do not include numbers, special characters, or the word 'keywords'.
**Output Format:** Respond with ONLY a valid JSON object with two keys: "title" and "keywords". The "keywords" value should be a single string of comma-separated values.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: img.file.type, data: base64Data } }] }],
                generation_config: { response_mime_type: "application/json" }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API Error: ${errorBody.error?.message || 'Unknown API error'}`);
            }

            const result = await response.json();
            const contentText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!contentText) throw new Error("Invalid response structure from API.");
            
            const content = JSON.parse(contentText);
            const finalTitle = (content.title || '').substring(0, 200);
            const finalKeywords = (content.keywords || '').split(',').map(k => k.trim()).filter(Boolean).slice(0, 49).join(', ');

            results[img.id] = { title: finalTitle, keywords: finalKeywords, status: 'Complete' };
            titleEl.value = finalTitle;
            keywordsEl.value = finalKeywords;
            updateStatus(img.id, 'Complete');
        } catch (error) {
            console.error(`Failed to process ${img.file.name}:`, error);
            updateStatus(img.id, 'Error');
            results[img.id] = { title: '', keywords: '', status: 'Error' };
            showToast(`Error processing ${img.file.name}. Check console.`, 'error');
        }
    };
    
    const updateStatus = (id, status) => {
        const statusEl = document.getElementById(`status-${id}`);
        if (!statusEl) return;
        
        if (!results[id]) results[id] = { title: '', keywords: ''};
        results[id].status = status;
        statusEl.textContent = status;
        
        statusEl.className = 'text-sm font-medium';
        if (status === 'Complete') statusEl.classList.add('text-green-400');
        else if (status === 'Error') statusEl.classList.add('text-red-400');
        else if (status === 'Generating...') statusEl.classList.add('text-blue-400', 'animate-pulse');
        else statusEl.classList.add('text-yellow-400');
    };

    const handleCsvDownload = () => {
        if (downloadCsvBtn.classList.contains('btn-disabled')) return;

        let csvContent = 'Filename,Title,Keywords\n';
        imageFiles.forEach(img => {
            const result = results[img.id];
            if (result && (result.status === 'Complete' || result.status === 'Error')) {
                const filename = img.file.name;
                const title = `"${(result.title || '').replace(/"/g, '""')}"`;
                const keywords = `"${(result.keywords || '').replace(/"/g, '""')}"`;
                csvContent += `${filename},${title},${keywords}\n`;
            }
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'adobe_stock_metadata.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV file downloaded!');
    };

    init();
});
</script>

</body>
</html>
